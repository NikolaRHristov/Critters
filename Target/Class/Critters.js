class I{constructor(t){this.options=Object.assign({logLevel:"info",path:"",publicPath:"",reduceInlineStyles:!0,pruneSource:!1,additionalStylesheets:[],allowRules:[]},t||{}),this.urlFilter=this.options.filter,this.urlFilter instanceof RegExp&&(this.urlFilter=this.urlFilter.test.bind(this.urlFilter)),this.logger=this.options.logger||createLogger(this.options.logLevel)}readFile(t){const r=this.fs;return new Promise((n,s)=>{const l=(i,a)=>{i?s(i):n(a)};r?.readFile?r.readFile(t,l):readFile(t,"utf8",l)})}async process(t){const r=process.hrtime.bigint(),n=createDocument(t);if(this.options.additionalStylesheets.length>0&&this.embedAdditionalStylesheet(n),this.options.external!==!1){const a=[].slice.call(n.querySelectorAll('link[rel="stylesheet"]'));await Promise.all(a.map(u=>this.embedLinkedStylesheet(u,n)))}const s=this.getAffectedStyleTags(n);await Promise.all(s.map(a=>this.processStyle(a,n))),this.options.mergeStylesheets!==!1&&s.length!==0&&await this.mergeStylesheets(n);const l=serializeDocument(n),i=process.hrtime.bigint();return this.logger.info(`Time ${Number.parseFloat(i-r)/1e6}`),l}getAffectedStyleTags(t){const r=[].slice.call(t.querySelectorAll("style"));return this.options.reduceInlineStyles===!1?r.filter(n=>n.$$external):r}async mergeStylesheets(t){const r=this.getAffectedStyleTags(t);if(r.length===0){this.logger.warn("Merging inline stylesheets into a single <style> tag skipped, no inline stylesheets to merge");return}const n=r[0];let s=n.textContent;for(let l=1;l<r.length;l++){const i=r[l];s+=i.textContent,i.remove()}n.textContent=s}async getCssAsset(t){const r=this.options.path,n=this.options.publicPath;let s=t.replace(/^\//,"");const l=`${(n||"").replace(/(^\/|\/$)/g,"")}/`;if(s.indexOf(l)===0&&(s=s.substring(l.length).replace(/^\//,"")),/^https?:\/\//.test(s)||t.startsWith("//"))return;const i=path.resolve(r,s);let a;try{a=await this.readFile(i)}catch{this.logger.warn(`Unable to locate stylesheet: ${i}`)}return a}checkInlineThreshold(t,r,n){if(this.options.inlineThreshold&&n.length<this.options.inlineThreshold){const s=r.$$name;return r.$$reduce=!1,this.logger.info(`\x1B[32mInlined all of ${s} (${n.length} was below the threshold of ${this.options.inlineThreshold})\x1B[39m`),t.remove(),!0}return!1}async embedAdditionalStylesheet(t){const r=[];(await Promise.all(this.options.additionalStylesheets.map(s=>{if(r.includes(s))return;r.push(s);const l=t.createElement("style");return l.$$external=!0,this.getCssAsset(s,l).then(i=>[i,l])}))).forEach(([s,l])=>{s&&(l.textContent=s,t.head.appendChild(l))})}async embedLinkedStylesheet(t,r){const n=t.getAttribute("href"),s=t.getAttribute("media"),l=this.options.preload;if(this.urlFilter?this.urlFilter(n):!(n||"").match(/\.css$/))return Promise.resolve();const i=r.createElement("style");i.$$external=!0;const a=await this.getCssAsset(n,i);if(!a||(i.textContent=a,i.$$name=n,i.$$links=[t],t.parentNode.insertBefore(i,t),this.checkInlineThreshold(t,i,a)))return;let u="function $loadcss(u,m,l){(l=document.createElement('link')).rel='stylesheet';l.href=u;document.head.appendChild(l)}";const y=l==="js-lazy";if(y&&(u=u.replace("l.href","l.media='print';l.onload=function(){l.media=m};l.href")),l===!1)return;let m=!1;if(l==="body")r.body.appendChild(t);else if(t.setAttribute("rel","preload"),t.setAttribute("as","style"),l==="js"||l==="js-lazy"){const f=r.createElement("script"),d=`${u}$loadcss(${JSON.stringify(n)}${y?`,${JSON.stringify(s||"all")}`:""})`;f.textContent=d,t.parentNode.insertBefore(f,t.nextSibling),i.$$links.push(f),u="",m=!0}else if(l==="media")t.setAttribute("rel","stylesheet"),t.removeAttribute("as"),t.setAttribute("media","print"),t.setAttribute("onload",`this.media='${s||"all"}'`),m=!0;else if(l==="swap-high")t.setAttribute("rel","alternate stylesheet preload"),t.setAttribute("title","styles"),t.setAttribute("onload","this.title='';this.rel='stylesheet'"),m=!0;else if(l==="swap")t.setAttribute("onload","this.rel='stylesheet'"),m=!0;else{const f=r.createElement("link");f.setAttribute("rel","stylesheet"),s&&f.setAttribute("media",s),f.setAttribute("href",n),r.body.appendChild(f),i.$$links.push(f)}if(this.options.noscriptFallback!==!1&&m){const f=r.createElement("noscript"),d=r.createElement("link");d.setAttribute("rel","stylesheet"),d.setAttribute("href",n),s&&d.setAttribute("media",s),f.appendChild(d),t.parentNode.insertBefore(f,t.nextSibling),i.$$links.push(f)}}pruneSource(t,r,n){const s=this.options.minimumExternalSize,l=t.$$name;if(s&&n.length<s){if(this.logger.info(`\x1B[32mInlined all of ${l} (non-critical external stylesheet would have been ${n.length}b, which was below the threshold of ${s})\x1B[39m`),t.textContent=r,t.$$links)for(const i of t.$$links){const a=i.parentNode;a&&a.removeChild(i)}return!0}return!1}async processStyle(t,r){if(t.$$reduce===!1)return;const n=t.$$name?t.$$name.replace(/^\//,""):"inline CSS",s=this.options,l=r.crittersContainer;let i=s.keyframes||"critical";i===!0&&(i="all"),i===!1&&(i="none");let a=t.textContent;const u=a;if(!a)return;const y=parseStylesheet(a),m=s.pruneSource?parseStylesheet(a):null;let f="";const d=[],C=[];let b=!1,$=!1,S=!1,A=!1;walkStyleRules(y,markOnly(c=>{if(c.type==="comment"){const o=c.text.trim();if(o.startsWith("critters"))switch(o.replace(/^critters:/,"")){case"include":{b=!0;break}case"exclude":{S=!0;break}case"include start":{$=!0;break}case"include end":{$=!1;break}case"exclude start":{A=!0;break}case"exclude end":{A=!1;break}}}if(c.type==="rule"){if(b)return b=!1,!0;if(S)return S=!1,!1;if($)return!0;if(A||(c.filterSelectors(o=>{if(s.allowRules.some(p=>p instanceof RegExp?p.test(o):p===o)||o===":root"||o.match(/^::?(before|after)$/)||o==="html"||o==="body")return!0;if(o=o.replace(/(?<!\\)::?[a-z-]+(?![a-z-(])/gi,"").replace(/::?not\(\s*\)/g,"").replace(/\(\s*,/g,"(").replace(/,\s*\)/g,")").trim(),!o)return!1;try{return l.exists(o)}catch{return d.push(`${o} -> ${e.message}`),!1}}),!c.selector))return!1;if(c.nodes)for(let o=0;o<c.nodes.length;o++){const h=c.nodes[o];if(h.prop?.match(/\bfont(-family)?\b/i)&&(f+=` ${h.value}`),h.prop==="animation"||h.prop==="animation-name"){const p=h.value.split(/\s+/);for(let w=0;w<p.length;w++){const k=p[w].trim();k&&C.push(k)}}}}if(c.type==="atrule"&&c.name==="font-face")return;const g=c.nodes?.filter(o=>!o.$$remove);return!g||g.length!==0})),d.length!==0&&this.logger.warn(`${d.length} rules skipped due to selector errors:
  ${d.join(`
  `)}`);const E=s.fonts===!0||s.preloadFonts===!0,P=s.fonts!==!1&&s.inlineFonts===!0,F=[];if(walkStyleRulesWithReverseMirror(y,m,c=>{if(c.$$remove===!0)return!1;if(applyMarkedSelectors(c),c.type==="atrule"&&c.name==="keyframes")return i==="none"?!1:i==="all"?!0:C.indexOf(c.params)!==-1;if(c.type==="atrule"&&c.name==="font-face"){let g,o;for(let h=0;h<c.nodes.length;h++){const p=c.nodes[h];p.prop==="src"?o=(p.value.match(/url\s*\(\s*(['"]?)(.+?)\1\s*\)/)||[])[2]:p.prop==="font-family"&&(g=p.value)}if(o&&E&&F.indexOf(o)===-1){F.push(o);const h=r.createElement("link");h.setAttribute("rel","preload"),h.setAttribute("as","font"),h.setAttribute("crossorigin","anonymous"),h.setAttribute("href",o.trim()),r.head.appendChild(h)}if(!(g&&o)||f.indexOf(g)===-1||!P)return!1}}),a=serializeStylesheet(y,{compress:this.options.compress!==!1}),a.trim().length===0){t.parentNode&&t.remove();return}let v="",x=!1;if(s.pruneSource){const c=serializeStylesheet(m,{compress:this.options.compress!==!1});x=this.pruneSource(t,u,c),x&&(v=`, reducing non-inlined size ${c.length/u.length*100|0}% to ${prettyBytes(c.length)}`)}x||(t.textContent=a);const z=a.length/u.length*100|0;this.logger.info(`\x1B[32mInlined ${prettyBytes(a.length)} (${z}% of original ${prettyBytes(u.length)}) of ${n}${v}.\x1B[39m`)}}export{I as default};
